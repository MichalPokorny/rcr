#!/usr/bin/ruby -w

dir = "/home/prvak/rocnikac/kgr-data/trained"

if ARGV[0] == "-i" || ARGV[0] == "--interactive"
	require 'kgr/gui/segment-word'
	gui = KGR::GUI::SegmentWord.new("#{dir}/word-segmenter", "#{dir}/letter-classifier")
	gui.run
else
	require 'kgr/word-segmentator/default'
	require 'kgr/word-segmentator/heuristic-oversegmentation'
	require 'kgr/letter-classifier/neural'
	require 'kgr/data/image'
	#require 'kgr/heuristic-oversegmenter/stupid'
	require 'kgr/heuristic-oversegmenter/local-minima'
	require 'kgr/markov-chain-model'

	classifier = KGR::LetterClassifier::Neural.load("#{dir}/letter-classifier")

#	segmentator = KGR::WordSegmentator::Default.load("#{dir}/word-segmenter")
#	model = KGR::MarkovChainModel.load_from_corpus(1, '../kgr-data/prepared/corpus')
	model = nil
	# Old: Stupid instead of LocalMinima
	segmentator = KGR::WordSegmentator::HeuristicOversegmentation.new(KGR::HeuristicOversegmenter::LocalMinima.new, classifier, model)

	i = 6

	image = KGR::Data::Image.load(ARGV[0] || "../kgr-data/input/segment/#{i}/data.png")
	segmentation = segmentator.segment(image)

	word_file = "../kgr-data/input/segment/#{i}/expect.txt"
	word = if File.exist?(word_file) then File.read(word_file).strip end

	puts "Segmentation says: #{segmentation.detected_text(classifier)}"

	word_segmentation = if word then segmentator.segment_for_word(image, word) end

	filename = "segmented.png"
	segmentator.show_oversegmentation(image) # Must be here.

	if word
		if word_segmentation
			with_best_found = image.dup
			word_segmentation.draw_on_image!(with_best_found)
			with_best_found.save("segmented_#{word}.png")
		else
			puts "Best segmentation for #{word} not found."
		end
	end

	segmentation.draw_on_image!(image)
	image.save(filename)

	puts "Segmented image saved in #{filename}"
end
