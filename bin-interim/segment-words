#!/usr/bin/ruby -w

require 'rcr/config'
dir = RCR::Config.trained_path

require 'rcr/word-segmentator/default'
require 'rcr/word-segmentator/heuristic-oversegmentation'
require 'rcr/letter-classifier/neural'
require 'rcr/data/image'
#require 'rcr/heuristic-oversegmenter/stupid'
require 'rcr/heuristic-oversegmenter/local-minima'
require 'rcr/markov-chain-model'

require 'rubyfish'

classifier = RCR::LetterClassifier::Neural.load("#{dir}/letter-classifier")

#	segmentator = RCR::WordSegmentator::Default.load("#{dir}/word-segmenter")
#	model = RCR::MarkovChainModel.load_from_corpus(1, '../rcr-data/prepared/corpus')
model = nil
# Old: Stupid instead of LocalMinima
segmentator = RCR::WordSegmentator::HeuristicOversegmentation.new(RCR::HeuristicOversegmenter::LocalMinima.new, classifier, model)

Dir[File.join(Config.segmentation_inputs_path, "*")].each do |input_dir|
	image = RCR::Data::Image.load(File.join(input_dir, "data.png"))
	segmentation = segmentator.segment(image)

	expect = File.read(File.join(input_dir, "expect.txt")).strip

	text = segmentation.detected_text(classifier)
	distance = RubyFish::Levenshtein.distance(text, expect)
	puts "Segmentation says: #{text}, expected: #{expect}. LSD = #{distance}"
	word_segmentation = segmentator.segment_for_word(image, expect)

	#filename = "segmented.png"
	segmentator.show_oversegmentation(image) # Must be here.

	if word_segmentation
		with_best_found = image.dup
		word_segmentation.draw_on_image!(with_best_found)
		with_best_found.save("segmented_#{expect}.png")
	else
		puts "Best segmentation for #{expect} not found."
	end

	#segmentation.draw_on_image!(image)
	#image.save(filename)

	#puts "Segmented image saved in #{filename}"
end

